name: ğŸš€ Deploy AutomÃ¡tico para VPS

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'backend/**'
      - 'infra/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy para VPS
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: ğŸ” Configurar SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
      
      - name: ğŸš€ Deploy na VPS
        run: |
          ssh -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              root@${{ secrets.VPS_IP }} << 'ENDSSH'
            set -e
            
            echo "ğŸš€ Deploy AutomÃ¡tico - $(date)"
            echo "===================================="
            
            cd /root/apps/propzy
            
            # Backup automÃ¡tico
            echo "ğŸ“¦ Criando backup..."
            BACKUP_FILE="backup-$(date +%Y%m%d-%H%M%S).tar.gz"
            tar -czf "$BACKUP_FILE" backend/ infra/ 2>/dev/null || true
            echo "âœ… Backup: $BACKUP_FILE"
            
            # Atualizar cÃ³digo
            echo "ğŸ“¥ Atualizando cÃ³digo..."
            git fetch origin
            CURRENT_BRANCH=$(git branch --show-current || echo "main")
            git reset --hard "origin/${CURRENT_BRANCH:-main}"
            echo "âœ… CÃ³digo atualizado"
            
            # Deploy
            cd infra
            echo "ğŸ”„ Reiniciando serviÃ§os..."
            docker compose restart web celery celery-beat
            sleep 15
            
            echo "ğŸ”„ Recarregando Nginx..."
            docker compose exec nginx nginx -s reload || docker compose restart nginx
            
            # Health check
            echo "ğŸ¥ Verificando saÃºde..."
            sleep 5
            if curl -f http://localhost/api/health/ > /dev/null 2>&1; then
              echo "âœ… Health check OK"
            else
              echo "âš ï¸ Health check falhou"
              exit 1
            fi
            
            echo "âœ… Deploy concluÃ­do!"
          ENDSSH
      
      - name: âœ… Deploy ConcluÃ­do
        if: success()
        run: echo "âœ… Deploy executado com sucesso!"



